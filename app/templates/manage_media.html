{% extends "layout.html" %}

{% block title %}Manage Media - NewsHub{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Manage Media</h1>
        <p class="text-gray-600 text-lg">Upload and manage images for your articles</p>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">üì§ Upload New Image</h2>
        
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Upload Form -->
            <div class="flex-1">
                <form id="uploadForm" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition duration-200" id="dropZone">
                        <input 
                            type="file" 
                            id="fileInput" 
                            name="file" 
                            accept="image/*" 
                            class="hidden"
                        >
                        <label for="fileInput" class="cursor-pointer">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-gray-600 font-semibold mb-2">Click to upload or drag and drop</p>
                            <p class="text-gray-500 text-sm">PNG, JPG, JPEG, GIF, WEBP (Max 10MB)</p>
                        </label>
                    </div>
                    
                    <!-- Preview -->
                    <div id="previewContainer" class="hidden">
                        <img id="previewImage" src="" alt="Preview" class="max-w-full h-48 object-contain rounded-lg border border-gray-200">
                        <p id="fileName" class="text-sm text-gray-600 mt-2 text-center"></p>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="uploadBtn"
                        class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        üì§ Upload Image
                    </button>
                </form>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="hidden mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="progressBar" class="bg-gray-600 h-4 rounded-full transition duration-200" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-600 mt-2 text-center">Uploading...</p>
                </div>
            </div>

            <!-- Upload Tips -->
            <div class="lg:w-80 bg-gray-50 rounded-lg p-6">
                <h3 class="font-bold text-gray-900 mb-4">üìù Upload Tips</h3>
                <ul class="text-gray-600 text-sm space-y-3">
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500">‚úì</span>
                        <span>Use high-quality images for better presentation</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500">‚úì</span>
                        <span>Recommended size: 1200x800 pixels</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500">‚úì</span>
                        <span>Supported formats: PNG, JPG, GIF, WEBP</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500">‚úì</span>
                        <span>Maximum file size: 10MB</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-500">‚úì</span>
                        <span>Images will be resized automatically</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Media Gallery -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-gray-50 px-8 py-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-2xl font-bold text-gray-900">üìö Image Gallery</h2>
            <span class="text-sm text-gray-600">Total: <span id="mediaCount">{{ media|length }}</span> images</span>
        </div>

        {% if media %}
        <div class="p-8">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="mediaGrid">
                {% for item in media %}
                <div class="media-item group relative bg-gray-100 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition duration-200" data-id="{{ item.id }}">
                    <div class="aspect-square">
                        <img 
                            src="{{ url_for('static', filename='uploads/' ~ item.filename) }}" 
                            alt="{{ item.original_name }}"
                            class="w-full h-full object-cover"
                            onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%%22 y=%2250%%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%239ca3af%22>No+Image</text></svg>'"
                        >
                    </div>
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                        <div class="flex gap-2">
                            <button
                                onclick="copyImageUrl('{{ url_for('static', filename='uploads/' ~ item.filename) }}')"
                                class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-500 transition duration-200"
                                title="Copy Image URL"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                            <button 
                                onclick="useInArticle('{{ url_for('static', filename='uploads/' ~ item.filename) }}')"
                                class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-500 transition duration-200"
                                title="Use in Article"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </button>
                            <button 
                                onclick="deleteMedia({{ item.id }})"
                                class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-500 transition duration-200"
                                title="Delete Image"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">
                        <p class="text-white text-xs truncate">{{ item.original_name }}</p>
                        <p class="text-gray-300 text-xs">{{ item.file_size }} bytes</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {% else %}
        <div class="px-8 py-12 text-center">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class="text-gray-600 text-lg mb-4">No images uploaded yet.</p>
            <p class="text-gray-500">Upload your first image using the form above</p>
        </div>
        {% endif %}
    </div>

    <!-- Back Link -->
    <div class="mt-8">
        <a href="/manage" class="text-blue-600 hover:text-blue-800 font-semibold flex items-center space-x-2">
            <span>‚Üê</span>
            <span>Back to Dashboard</span>
        </a>
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg font-semibold text-white z-50 hidden transition duration-300 transform translate-y-4 opacity-0">
</div>

{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const fileName = document.getElementById('fileName');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const mediaGrid = document.getElementById('mediaGrid');

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file', 'error');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('File size must be less than 10MB', 'error');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.classList.remove('hidden');
                fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
                uploadBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
    });

    // Form submit handler
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const file = fileInput.files[0];
        if (!file) return;

        // Show progress
        uploadProgress.classList.remove('hidden');
        uploadBtn.disabled = true;
        progressBar.style.width = '50%';
        progressText.textContent = 'Uploading...';

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/media', {
                method: 'POST',
                body: formData
            });

            progressBar.style.width = '100%';

            if (response.ok) {
                const data = await response.json();
                progressText.textContent = 'Upload complete!';
                
                showToast('Image uploaded successfully!', 'success');
                
                // Reset form
                uploadForm.reset();
                previewContainer.classList.add('hidden');
                uploadBtn.disabled = true;

                // Add new item to grid
                addMediaToGrid(data.media);

                // Update count
                updateMediaCount();
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Upload failed');
            }
        } catch (error) {
            showToast(error.message, 'error');
        } finally {
            setTimeout(() => {
                uploadProgress.classList.add('hidden');
                progressBar.style.width = '0%';
                uploadBtn.disabled = false;
            }, 1500);
        }
    });

    // Add media item to grid
    function addMediaToGrid(media) {
        if (!mediaGrid) return;
        
        const item = document.createElement('div');
        item.className = 'media-item group relative bg-gray-100 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition duration-200';
        item.setAttribute('data-id', media.id);
        
        const imageUrl = '/static/uploads/' + media.filename;
        const escapedOriginalName = media.original_name.replace(/'/g, "\\'");
        
        item.innerHTML = '<div class="aspect-square">' +
            '<img src="' + imageUrl + '" alt="' + escapedOriginalName + '" class="w-full h-full object-cover" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%239ca3af%22>No+Image</text></svg>\'">' +
            '</div>' +
            '<div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">' +
            '<div class="flex gap-2">' +
            '<button onclick="copyImageUrl(\'' + imageUrl + '\')" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition duration-200" title="Copy Image URL">' +
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>' +
            '</button>' +
            '<button onclick="useInArticle(\'' + imageUrl + '\')" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition duration-200" title="Use in Article">' +
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>' +
            '</button>' +
            '<button onclick="deleteMedia(' + media.id + ')" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition duration-200" title="Delete Image">' +
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>' +
            '</button>' +
            '</div>' +
            '</div>' +
            '<div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-2">' +
            '<p class="text-white text-xs truncate">' + escapedOriginalName + '</p>' +
            '<p class="text-gray-300 text-xs">' + formatFileSize(media.file_size) + '</p>' +
            '</div>';

        mediaGrid.insertBefore(item, mediaGrid.firstChild);
    }

    // Delete media
    async function deleteMedia(id) {
        if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/media/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const item = document.querySelector(`.media-item[data-id="${id}"]`);
                if (item) {
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        item.remove();
                        updateMediaCount();
                    }, 300);
                }
                showToast('Image deleted successfully!', 'success');
            } else {
                throw new Error('Failed to delete image');
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    // Copy image URL
    function copyImageUrl(url) {
        navigator.clipboard.writeText(window.location.origin + url).then(() => {
            showToast('Image URL copied to clipboard!', 'success');
        }).catch(() => {
            showToast('Failed to copy URL', 'error');
        });
    }

    // Use image in article
    function useInArticle(url) {
        // Store the image URL in sessionStorage for use in article creation
        sessionStorage.setItem('selectedImageUrl', url);
        window.location.href = '/articles/create';
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg font-semibold text-white z-50 transition duration-300 transform ${
            type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
        }`;
        toast.classList.remove('hidden', 'translate-y-4', 'opacity-0');
        
        setTimeout(() => {
            toast.classList.add('translate-y-4', 'opacity-0');
            setTimeout(() => toast.classList.add('hidden'), 300);
        }, 3000);
    }

    // Update media count
    function updateMediaCount() {
        const count = document.querySelectorAll('.media-item').length;
        document.getElementById('mediaCount').textContent = count;
    }

    // Drag and drop support
    const dropZone = document.getElementById('dropZone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        }, false);
    });

    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length) {
            fileInput.files = files;
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }
    });
</script>
{% endblock %}

