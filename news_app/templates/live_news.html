{% extends "layout.html" %}

{% block title %}Live News - NewsHub{% endblock %}

{% block content %}
<div class="mb-8 scale-in">
    <div class="flex items-center justify-between mb-4 slide-in-left">
        <div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                ðŸ”´ Live News
            </h1>
            <p class="text-gray-600 text-lg">Breaking news and latest updates from around the world</p>
        </div>
        <div class="text-center">
            <span class="inline-block bg-red-100 text-red-800 px-4 py-2 rounded-full font-semibold text-sm badge-animate">
                ðŸ“¡ Live Feed
            </span>
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8 form-group-animate">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input 
            type="text" 
            id="searchInput" 
            placeholder="Search news by keyword..." 
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus-glow"
        >
        <select 
            id="categoryFilter" 
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus-glow bg-white"
        >
            <option value="">All Categories</option>
            <option value="business">Business</option>
            <option value="entertainment">Entertainment</option>
            <option value="health">Health</option>
            <option value="science">Science</option>
            <option value="sports">Sports</option>
            <option value="technology">Technology</option>
        </select>
        <select 
            id="sortFilter" 
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus-glow bg-white"
        >
            <option value="publishedAt">Latest First</option>
            <option value="popularity">Most Popular</option>
            <option value="relevancy">Most Relevant</option>
        </select>
        <button 
            onclick="loadLiveNews()" 
            class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-200 font-semibold flex items-center justify-center gap-2 hover:scale-105 transform"
        >
            ðŸ”„ Refresh
        </button>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="hidden text-center py-12">
    <div class="inline-block">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
        <p class="mt-4 text-gray-600 font-semibold">Loading live news...</p>
    </div>
</div>

<!-- Error Message -->
<div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-600 p-4 mb-8 rounded">
    <p class="text-red-700 font-semibold" id="errorText"></p>
    <p class="text-red-600 text-sm mt-2 flex items-center gap-2">
        <span>ðŸ’¡ Troubleshooting:</span>
    </p>
    <ul class="text-red-600 text-sm mt-2 list-disc list-inside">
        <li>Verify your NewsApi.org API key is valid</li>
        <li>Check your API key at <a href="https://newsapi.org" target="_blank" class="underline">newsapi.org</a></li>
        <li>Ensure you have a valid subscription plan</li>
        <li>Check your API usage quota (free tier: 100 requests/day)</li>
    </ul>
</div>

<!-- Articles Grid -->
<div id="articlesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Articles will be loaded here -->
</div>

<!-- No Results Message -->
<div id="emptyState" class="hidden text-center py-12">
    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <p class="text-gray-600 text-lg">No news articles found. Try adjusting your search.</p>
</div>

<!-- Load More Button -->
<div class="text-center mt-12">
    <button 
        id="loadMoreBtn" 
        onclick="loadMoreNews()" 
        class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition duration-200 font-semibold hidden"
    >
        Load More Articles
    </button>
</div>

{% endblock %}
{% block scripts %}
<script>
// API Configuration
const BACKEND_API_URL = '/api';

let currentPage = 1;
let currentQuery = '';
let currentCategory = '';
let currentSort = 'publishedAt';
let allArticles = [];

// Load initial live news
document.addEventListener('DOMContentLoaded', function() {
    loadLiveNews();
    
    // Event listeners for filters
    document.getElementById('searchInput').addEventListener('input', debounce(searchNews, 500));
    document.getElementById('categoryFilter').addEventListener('change', filterNews);
    document.getElementById('sortFilter').addEventListener('change', sortNews);
});

function loadLiveNews() {
    showLoading(true);
    hideError();
    
    currentPage = 1;
    currentQuery = '';
    currentCategory = '';
    allArticles = [];
    
    // Fetch latest news from backend API
    const params = new URLSearchParams({
        country: 'us',
        pageSize: 10,
        page: currentPage
    });
    if (currentCategory) params.append('category', currentCategory);
    
    const url = `${BACKEND_API_URL}/live?${params}`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('âš ï¸ Invalid or Unauthorized API Key. Please check your NewsApi.org API key.');
                } else if (response.status === 429) {
                    throw new Error('â±ï¸ API rate limit exceeded. Please try again later.');
                } else if (response.status === 400) {
                    throw new Error('âŒ Bad Request (HTTP 400). Invalid parameters sent to API.');
                }
                throw new Error(`âŒ API Error: HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                allArticles = data.articles || [];
                displayArticles(allArticles);
                showLoading(false);
                
                // Show load more button if we have articles
                if (allArticles.length > 0) {
                    document.getElementById('loadMoreBtn').classList.remove('hidden');
                }
            } else {
                throw new Error(`ðŸ“° API Response: ${data.message || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Full Error:', error);
            showError(error.message);
            showLoading(false);
            displayArticles([]);
        });
}

function searchNews() {
    const query = document.getElementById('searchInput').value.trim();
    
    if (!query) {
        loadLiveNews();
        return;
    }
    
    showLoading(true);
    hideError();
    currentPage = 1;
    currentQuery = query;
    allArticles = [];
    
    const params = new URLSearchParams({
        q: query,
        sortBy: currentSort,
        pageSize: 20,
        page: currentPage
    });
    
    const url = `${BACKEND_API_URL}/search?${params}`;
    
    fetch(url, {
        method: 'GET',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`âŒ API Error: HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                allArticles = data.articles || [];
                displayArticles(allArticles);
            } else {
                throw new Error(data.message || 'No results found');
            }
            showLoading(false);
        })
        .catch(error => {
            console.error('Search Error:', error);
            showError(error.message);
            showLoading(false);
            displayArticles([]);
        });
}

function filterNews() {
    const category = document.getElementById('categoryFilter').value;
    currentCategory = category;
    
    if (category) {
        showLoading(true);
        hideError();
        currentPage = 1;
        allArticles = [];
        
        const params = new URLSearchParams({
            category: category,
            country: 'us',
            pageSize: 20,
            page: currentPage
        });
        const url = `${BACKEND_API_URL}/live?${params}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch news');
                return response.json();
            })
            .then(data => {
                if (data.status === 'ok') {
                    allArticles = data.articles || [];
                    displayArticles(allArticles);
                }
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                showError(error.message);
                showLoading(false);
            });
    } else {
        loadLiveNews();
    }
}

function sortNews() {
    currentSort = document.getElementById('sortFilter').value;
    
    if (currentQuery) {
        searchNews();
    } else if (currentCategory) {
        filterNews();
    } else {
        loadLiveNews();
    }
}

function loadMoreNews() {
    currentPage++;
    showLoading(true);
    
    let url;
    const params = new URLSearchParams({
        page: currentPage,
        pageSize: 20
    });
    
    if (currentQuery) {
        params.append('q', currentQuery);
        params.append('sortBy', currentSort);
        url = `${BACKEND_API_URL}/search?${params}`;
    } else if (currentCategory) {
        params.append('category', currentCategory);
        params.append('country', 'us');
        url = `${BACKEND_API_URL}/live?${params}`;
    } else {
        params.append('country', 'us');
        url = `${BACKEND_API_URL}/live?${params}`;
    }
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch more news');
            return response.json();
        })
        .then(data => {
            if (data.status === 'ok') {
                const newArticles = data.articles || [];
                allArticles = [...allArticles, ...newArticles];
                appendArticles(newArticles);
            }
            showLoading(false);
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to load more articles');
            showLoading(false);
        });
}

function displayArticles(articles) {
    const container = document.getElementById('articlesContainer');
    container.innerHTML = '';
    
    if (!articles || articles.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('loadMoreBtn').classList.add('hidden');
        return;
    }
    
    document.getElementById('emptyState').classList.add('hidden');
    articles.forEach(article => {
        const articleHTML = createArticleCard(article);
        container.innerHTML += articleHTML;
    });
}

function appendArticles(articles) {
    const container = document.getElementById('articlesContainer');
    articles.forEach(article => {
        const articleHTML = createArticleCard(article);
        container.innerHTML += articleHTML;
    });
}

function createArticleCard(article) {
    const imageUrl = article.urlToImage || article.image || 'https://via.placeholder.com/400x200?text=No+Image';
    const source = article.source && article.source.name ? article.source.name : (article.source_id || article.source || 'Unknown Source');
    const publishedDate = new Date(article.publishedAt || article.pubDate);
    const formattedDate = publishedDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const description = article.description ? article.description.substring(0, 150) + '...' : 'No description available';
    const title = article.title ? article.title.substring(0, 70) : 'Untitled';
    const link = article.url || article.link || '#';
    
    return `
        <div class="live-card-modern bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all duration-300">
            <div class="relative overflow-hidden h-52">
                <img src="${imageUrl}" alt="${title}" class="w-full h-full object-cover hover:scale-105 transition duration-500" onerror="this.src='https://via.placeholder.com/400x200?text=News+Image'">
                <div class="absolute top-3 right-3 bg-red-600 text-white px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1 shadow-lg">
                    <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                    LIVE
                </div>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent h-20"></div>
                <div class="absolute bottom-2 left-3 text-white text-xs font-medium">
                    ${source}
                </div>
            </div>
            <div class="p-5">
                <div class="flex items-center justify-between mb-3">
                    <span class="bg-blue-50 text-blue-700 px-2.5 py-1 rounded text-xs font-semibold">${source}</span>
                    <span class="text-gray-500 text-xs flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ${formattedDate}
                    </span>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 hover:text-blue-600 transition-colors">${title}</h3>
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">${description}</p>
                <div class="flex gap-2">
                    <a href="${link}" target="_blank" rel="noopener noreferrer" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded-lg hover:bg-red-700 transition duration-200 text-center font-semibold text-sm flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        Read Full Article
                    </a>
                    <button onclick="shareArticle('${encodeURIComponent(title)}', '${encodeURIComponent(link)}')" class="bg-gray-100 text-gray-700 px-4 py-2.5 rounded-lg hover:bg-gray-200 transition duration-200 flex items-center justify-center" title="Share">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function shareArticle(title, url) {
    if (navigator.share) {
        navigator.share({
            title: decodeURIComponent(title),
            url: decodeURIComponent(url)
        }).catch(err => console.log('Error sharing:', err));
    } else {
        // Fallback: Copy to clipboard
        const text = `${decodeURIComponent(title)}\n${decodeURIComponent(url)}`;
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Article link copied to clipboard!', 'success');
        });
    }
}

function showLoading(show) {
    document.getElementById('loadingSpinner').classList.toggle('hidden', !show);
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').classList.remove('hidden');
}

function hideError() {
    document.getElementById('errorMessage').classList.add('hidden');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg font-semibold text-white z-50 ${
        type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    notification.textContent = message;
    notification.style.animation = 'slideInUp 0.3s ease-out';
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(20px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Debounce function for search
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}
</script>
{% endblock %}

