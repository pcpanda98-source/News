 {% extends "layout.html" %}

{% block title %}Manage Articles - News Management System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto scale-in">
    <div class="mb-8 flex items-center justify-between slide-in-left">
        <div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                üìÑ Manage Articles
            </h1>
            <p class="text-gray-600 text-lg">View, edit, and manage all articles</p>
        </div>
        <a href="/articles/create" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 hover:scale-105 transition-all duration-200 inline-flex items-center space-x-2">
            <span>‚ûï</span>
            <span>Create New Article</span>
        </a>
    </div>

    <!-- Filter and Search Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8 form-group-animate">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search articles by title..." 
                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus-glow"
            >
            <select 
                id="categoryFilter" 
                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus-glow bg-white"
            >
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
            </select>
            <select 
                id="sortFilter" 
                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus-glow bg-white"
            >
                <option value="recent">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="title">Alphabetical</option>
            </select>
            <button 
                onclick="resetFilters()" 
                class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 hover:scale-105 transition-all duration-200 flex items-center gap-1"
            >
                üîÑ Reset Filters
            </button>
        </div>
    </div>

    <!-- Articles Management Table -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-gray-50 px-8 py-4 border-b border-gray-200 flex items-center justify-between section-header-animate">
            <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">üìä All Articles</h2>
            <span class="text-sm text-gray-600">Total: <span id="totalCount">{{ articles|length }}</span></span>
        </div>

        {% if articles %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">ID</th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Title</th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Author</th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Category</th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Created</th>
                        <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Preview</th>
                        <th class="px-6 py-4 text-center text-sm font-bold text-gray-700">Actions</th>
                    </tr>
                </thead>
<tbody id="articlesTable">
                    {% for article in articles %}
                    <tr class="article-row border-b border-gray-200 hover:bg-gray-50 transition duration-200 table-row-animate" data-id="{{ article.id }}" data-title="{{ article.title|lower }}" data-category="{{ article.category.id if article.category else '' }}" data-date="{{ article.created_at.strftime('%s') if article.created_at else '0' }}">
                        <td class="px-6 py-4 text-sm text-gray-700">
                            <span class="font-mono font-bold text-blue-600">#{{ article.id }}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="max-w-xs">
                                <p class="text-sm font-semibold text-gray-900 truncate">{{ article.title }}</p>
                                <p class="text-xs text-gray-500 truncate">{{ article.content[:50] }}...</p>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {% if article.author %}
                            <span class="flex items-center gap-1 text-gray-700">
                                <span class="icon-bounce">‚úçÔ∏è</span>
                                <span class="font-medium">{{ article.author }}</span>
                            </span>
                            {% else %}
                            <span class="text-gray-500 text-xs">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {% if article.category %}
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold badge-animate">
                                {{ article.category.name }}
                            </span>
                            {% else %}
                            <span class="text-gray-500 text-xs">‚Äî</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            <span class="text-xs">{{ article.created_at.strftime('%b %d, %Y') if article.created_at else 'Recently' }}</span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            {% if article.image_url %}
                            <div class="w-12 h-12 rounded-lg overflow-hidden zoom-subtle">
                                <img 
                                    src="{{ article.image_url }}" 
                                    alt="Preview"
                                    class="w-full h-full object-cover"
                                    onerror="this.parentElement.innerHTML='<div class=\'w-12 h-12 rounded-lg bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center\'><span class=\'text-xl\'>üì∞</span></div>'"
                                >
                            </div>
                            {% else %}
                            <span class="text-xs text-gray-500">{{ article.content|length }} chars</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex items-center justify-center gap-3">
                                <a 
                                    href="/articles/{{ article.id }}" 
                                    class="text-blue-400 hover:text-blue-300 font-semibold transition duration-200 text-sm hover-scale-icon"
                                    title="View Article"
                                >
                                    üëÅÔ∏è View
                                </a>
                                <button 
                                    type="button"
                                    class="text-blue-400 hover:text-blue-300 font-semibold transition duration-200 text-sm hover-scale-icon edit-btn"
                                    data-id="{{ article.id }}"
                                    data-title="{{ article.title }}"
                                    data-author="{{ article.author if article.author else '' }}"
                                    data-category="{{ article.category.id if article.category else '' }}"
                                    data-content="{{ article.content }}"
                                    data-image-url="{{ article.image_url if article.image_url else '' }}"
                                    title="Edit Article"
                                >
                                    ‚úèÔ∏è Edit
                                </button>
                                <button 
                                    type="button"
                                    class="text-red-400 hover:text-red-300 font-semibold transition duration-200 text-sm hover-scale-icon delete-btn"
                                    data-id="{{ article.id }}"
                                    title="Delete Article"
                                >
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="bg-gray-50 px-8 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <p class="text-sm text-gray-600">
                    Showing <span id="visibleCount">{{ articles|length }}</span> of <span id="totalCountFooter">{{ articles|length }}</span> articles
                </p>
                <div class="text-sm text-gray-500">
                    <span id="selectedCount">0</span> selected
                </div>
            </div>
        </div>

        {% else %}
        <div class="px-8 py-12 text-center">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-600 text-lg mb-4">No articles available yet.</p>
            <a 
                href="/articles/create" 
                class="bg-gray-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 inline-block"
            >
                Create First Article
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Back Link -->
    <div class="mt-8 flex justify-end">
        <a href="/articles" class="text-indigo-600 hover:text-blue-800 font-semibold flex items-center space-x-2 hover:translate-x-1 transition-transform duration-200">
            <span>‚¨ÖÔ∏è</span>
            <span>Back to Articles</span>
        </a>
    </div>
</div>

<!-- Edit Article Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-8 py-4">
            <h3 class="text-2xl font-bold text-gray-900">‚úèÔ∏è Edit Article</h3>
        </div>
        <div class="p-8">
            <form id="editForm" onsubmit="submitEdit(event)">
                <div class="mb-6">
                    <label for="editTitle" class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                    <input 
                        type="text" 
                        id="editTitle" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    >
                </div>

                <!-- Author Field -->
                <div class="mb-6">
                    <label for="editAuthor" class="block text-sm font-semibold text-gray-700 mb-2">Author Name</label>
                    <input 
                        type="text" 
                        id="editAuthor" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter author name..."
                    >
                </div>

                <!-- Image URL Field -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Featured Image</label>
                    <input type="hidden" id="editImageUrl" name="image_url" value="">
                    
                    <!-- Image Upload Options -->
                    <div class="flex flex-col gap-4">
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition duration-200" id="editImageDropZone">
                            <input 
                                type="file" 
                                id="editImageFile" 
                                accept="image/*"
                                class="hidden"
                            >
                            <label for="editImageFile" class="cursor-pointer">
                                <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <p class="text-gray-600 font-medium text-sm">Click to upload image</p>
                                <p class="text-gray-500 text-xs">PNG, JPG, GIF, WEBP (Max 10MB)</p>
                            </label>
                        </div>
                        
                        <p class="text-center text-gray-500 font-medium text-sm">‚Äî OR ‚Äî</p>
                        
                        <button 
                            type="button" 
                            onclick="openEditMediaLibrary()"
                            class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 flex items-center justify-center gap-2"
                        >
                            üì∑ Select from Media Library
                        </button>
                    </div>
                    
                    <!-- Image Preview -->
                    <div id="editImagePreview" class="hidden mt-4 p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Current Image:</p>
                        <img id="editPreviewImg" src="" alt="Preview" class="max-w-full max-h-40 object-contain rounded-lg border border-gray-200 bg-white">
                        <div class="flex gap-2 mt-2">
                            <button 
                                type="button" 
                                onclick="clearEditImage()"
                                class="text-red-600 hover:text-red-800 text-sm font-semibold flex items-center gap-1"
                            >
                                üóëÔ∏è Remove Image
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="editCategory" class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
                    <select 
                        id="editCategory" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                    >
                        <option value="">No Category</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-6">
                    <label for="editContent" class="block text-sm font-semibold text-gray-700 mb-2">Content</label>
                    <textarea 
                        id="editContent" 
                        rows="8"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"
                        required
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-2">
                        <span id="editCharCount">0</span> characters
                    </p>
                </div>

                <input type="hidden" id="editArticleId">

                <div class="flex gap-4 sticky bottom-0 bg-white pt-4 border-t border-gray-200">
                    <button 
                        type="submit" 
                        class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200"
                    >
                        Save Changes
                    </button>
                    <button 
                        type="button" 
                        onclick="closeEditModal()" 
                        class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition duration-200"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Media Library Modal for Edit -->
<div id="editMediaModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 my-8 max-h-[80vh] flex flex-col">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-bold text-gray-900">üì∑ Select Image</h3>
            <button onclick="closeEditMediaLibrary()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto" id="editMediaLibraryContent">
            <p class="text-gray-600 text-center">Loading media library...</p>
        </div>
    </div>
</div>

<!-- Stats Section -->
<div class="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white rounded-lg shadow-md p-6 text-center stat-animate card-hover-lift">
        <div class="text-4xl font-bold text-blue-600 mb-2">{{ articles|length }}</div>
        <p class="text-gray-600">Total Articles</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 text-center stat-animate card-hover-lift">
        <div class="text-4xl font-bold text-green-600 mb-2">{{ categories|length }}</div>
        <p class="text-gray-600">Categories</p>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 text-center stat-animate card-hover-lift">
        <div class="text-4xl font-bold text-purple-600 mb-2">{{ (articles|length * 100 / 1000)|int }}%</div>
        <p class="text-gray-600">Database Usage</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Image upload elements for edit modal
const editImageFileInput = document.getElementById('editImageFile');
const editImageDropZone = document.getElementById('editImageDropZone');
const editImageUrlInput = document.getElementById('editImageUrl');
const editImagePreview = document.getElementById('editImagePreview');
const editPreviewImg = document.getElementById('editPreviewImg');

// Article Management Functions
function editArticle(id, title, author, categoryId, content, imageUrl = '') {
    document.getElementById('editArticleId').value = id;
    document.getElementById('editTitle').value = title;
    document.getElementById('editAuthor').value = author || '';
    document.getElementById('editCategory').value = categoryId;
    document.getElementById('editContent').value = content;
    
    // Set image URL
    editImageUrlInput.value = imageUrl || '';
    if (imageUrl) {
        editPreviewImg.src = imageUrl;
        editImagePreview.classList.remove('hidden');
    } else {
        editImagePreview.classList.add('hidden');
    }
    
    updateCharCount();
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editTitle').focus();
}

// Clear edit image
function clearEditImage() {
    editImageUrlInput.value = '';
    editPreviewImg.src = '';
    editImagePreview.classList.add('hidden');
}

// Open media library for edit
async function openEditMediaLibrary() {
    const modal = document.getElementById('editMediaModal');
    const content = document.getElementById('editMediaLibraryContent');
    modal.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/media');
        const data = await response.json();
        
        if (data.media && data.media.length > 0) {
            content.innerHTML = `
                <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    ${data.media.map(item => `
                        <div class="media-item group relative bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-500 transition duration-200" onclick="selectEditMedia('${item.file_path}')">
                            <div class="aspect-square">
                                <img 
                                    src="${item.file_path}" 
                                    alt="${item.original_name}"
                                    class="w-full h-full object-cover"
                                    onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2212%22 fill=%22%239ca3af%22>No+Image</text></svg>'"
                                >
                            </div>
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition duration-200 flex items-center justify-center">
                                <span class="text-white font-semibold opacity-0 group-hover:opacity-100 transition duration-200">Select</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            content.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-gray-600 mb-4">No images in media library.</p>
                    <a href="/media/manage" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-700 transition duration-200 inline-block">
                        üì§ Upload Images
                    </a>
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `<p class="text-red-600 text-center">Error loading media library.</p>`;
    }
}

// Close media library for edit
function closeEditMediaLibrary() {
    document.getElementById('editMediaModal').classList.add('hidden');
}

// Select media for edit
function selectEditMedia(filePath) {
    editImageUrlInput.value = filePath;
    editPreviewImg.src = filePath;
    editImagePreview.classList.remove('hidden');
    closeEditMediaLibrary();
}

// Edit image file upload handler
editImageFileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
    }
    
    // Upload the image
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        const response = await fetch('/api/media', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            editImageUrlInput.value = data.media.file_path;
            editPreviewImg.src = data.media.file_path;
            editImagePreview.classList.remove('hidden');
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to upload image');
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to upload image');
    }
});

// Drag and drop support for edit image upload
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    editImageDropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    editImageDropZone.addEventListener(eventName, () => {
        editImageDropZone.classList.add('border-blue-500', 'bg-blue-50');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    editImageDropZone.addEventListener(eventName, () => {
        editImageDropZone.classList.remove('border-blue-500', 'bg-blue-50');
    }, false);
});

editImageDropZone.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length) {
        editImageFileInput.files = files;
        const event = new Event('change');
        editImageFileInput.dispatchEvent(event);
    }
});

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    // Clear image upload
    editImageFileInput.value = '';
    editImageUrlInput.value = '';
    editImagePreview.classList.add('hidden');
}

function updateCharCount() {
    const content = document.getElementById('editContent').value;
    document.getElementById('editCharCount').textContent = content.length;
}

function submitEdit(event) {
    event.preventDefault();
    const id = document.getElementById('editArticleId').value;
    const title = document.getElementById('editTitle').value;
    const author = document.getElementById('editAuthor').value || null;
    const categoryId = document.getElementById('editCategory').value || null;
    const content = document.getElementById('editContent').value;
    const imageUrl = document.getElementById('editImageUrl').value;

    fetch(`/api/articles/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            title: title, 
            author: author,
            content: content, 
            category_id: categoryId,
            image_url: imageUrl
        })
    })
    .then(response => {
        if (response.ok) {
            closeEditModal();
            showNotification('Article updated successfully!', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showNotification('Error updating article', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error updating article', 'error');
    });
}

function deleteArticle(id) {
    if (confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
        fetch(`/api/articles/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                const row = document.querySelector(`[data-id="${id}"]`);
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    row.remove();
                    updateStats();
                    showNotification('Article deleted successfully!', 'success');
                }, 300);
            } else {
                showNotification('Error deleting article', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error deleting article', 'error');
        });
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg font-semibold text-white z-50 ${
        type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    notification.textContent = message;
    notification.style.animation = 'slideInUp 0.3s ease-out';
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(20px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Event Delegation for Edit and Delete Buttons
document.addEventListener('DOMContentLoaded', function() {
    // Edit button click handler
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const title = this.dataset.title;
            const author = this.dataset.author || '';
            const categoryId = this.dataset.category;
            const content = this.dataset.content;
            const imageUrl = this.dataset.imageUrl || '';
            editArticle(id, title, author, categoryId, content, imageUrl);
        });
    });

    // Delete button click handler
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            deleteArticle(id);
        });
    });

    // Filter and Search Functions
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const sortFilter = document.getElementById('sortFilter');
    const articlesTable = document.getElementById('articlesTable');
    const articleRows = document.querySelectorAll('.article-row');

    function filterAndSort() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        const sortBy = sortFilter.value;
        
        let visibleRows = [];
        
        articleRows.forEach(row => {
            const title = row.dataset.title;
            const category = row.dataset.category;
            
            const matchesSearch = title.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            
            if (matchesSearch && matchesCategory) {
                row.style.display = '';
                visibleRows.push(row);
            } else {
                row.style.display = 'none';
            }
        });
        
        // Sort visible rows
        visibleRows.sort((a, b) => {
            if (sortBy === 'recent') {
                return parseInt(b.dataset.date) - parseInt(a.dataset.date);
            } else if (sortBy === 'oldest') {
                return parseInt(a.dataset.date) - parseInt(b.dataset.date);
            } else if (sortBy === 'title') {
                return a.dataset.title.localeCompare(b.dataset.title);
            }
        });
        
        // Reorder rows in table
        visibleRows.forEach(row => {
            articlesTable.appendChild(row);
        });
        
        updateStats();
    }

    function resetFilters() {
        searchInput.value = '';
        categoryFilter.value = '';
        sortFilter.value = 'recent';
        filterAndSort();
    }

    function updateStats() {
        const visibleRows = Array.from(articleRows).filter(row => row.style.display !== 'none');
        document.getElementById('visibleCount').textContent = visibleRows.length;
        document.getElementById('selectedCount').textContent = '0';
    }

    // Event Listeners
    searchInput.addEventListener('input', filterAndSort);
    categoryFilter.addEventListener('change', filterAndSort);
    sortFilter.addEventListener('change', filterAndSort);
    document.getElementById('editContent').addEventListener('input', updateCharCount);

    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });

    // Expose resetFilters to window for button
    window.resetFilters = resetFilters;

    // Initial stats
    updateStats();
});
</script>
{% endblock %}
